<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout}"> 
    <head> 
        <meta charset="UTF-8"> 
        <title>ATM Premium</title> 

        <style>
            .main-content {
                min-height: calc(100vh - 56px);
                display: flex;
                align-items: center;
                justify-content: center;
                background: radial-gradient(circle at center, #1b263b, #0d1b2a);
            }

            .atm-container {
                background: linear-gradient(145deg, #3b4d61, #1e2936);
                border-radius: 40px;
                padding: 45px;
                display: flex;
                gap: 50px;
                box-shadow:
                    0 40px 100px rgba(0,0,0,0.8),
                    inset 0 2px 5px rgba(255,255,255,0.1);
                border: 5px solid #2c3e50;
            }

            .atm-screen {
                width: 480px;
                min-height: 420px;
                background: #e6edf5;
                border-radius: 12px;
                padding: 30px;
                box-shadow:
                    inset 0 0 30px rgba(0,0,0,0.2),
                    0 0 0 12px #111;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow: hidden;
                box-sizing: border-box;
            }

            #atmMessage {
                display: none;
                background: #2ecc71;
                color: white;
                padding: 15px;
                border-radius: 8px;
                font-weight: bold;
                text-align: center;
                margin-bottom: 20px;
            }

            .atm-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 20px;
                margin-top: 10px;
            }

            .btn-action {
                padding: 18px;
                background: linear-gradient(145deg, #2c3e50, #1a252f);
                border: 1px solid #444;
                border-radius: 12px;
                font-weight: bold;
                color: #ecf0f1;
                cursor: pointer;
                box-shadow: 0 5px 0 #111;
                transition: transform 0.1s;
            }

            .btn-action:active {
                transform: translateY(4px);
                box-shadow: none;
            }

            .atm-input {
                width: 100%;
                padding: 14px;
                border-radius: 8px;
                border: 2px solid #bdc3c7;
                margin-bottom: 15px;
                font-size: 18px;
                box-sizing: border-box;
            }

            .btn-enter {
                width: 100%;
                padding: 16px;
                background: #27ae60;
                border: none;
                border-radius: 10px;
                font-weight: bold;
                color: white;
                cursor: pointer;
            }

            .atm-keypad {
                width: 220px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }

            .atm-keypad button {
                padding: 22px 10px;
                background: linear-gradient(145deg, #bdc3c7, #95a5a6);
                border: 1px solid #7f8c8d;
                border-radius: 8px;
                font-weight: bold;
                box-shadow: 0 4px 0 #7f8c8d;
            }

            .clear {
                background: #e74c3c !important;
                color: white !important;
                box-shadow: 0 4px 0 #c0392b !important;
            }
            .ok {
                background: #2ecc71 !important;
                color: white !important;
                box-shadow: 0 4px 0 #27ae60 !important;
            }

            .slots-container {
                margin-top: 30px;
                display: flex;
                flex-direction: column;
                gap: 35px;
            }
            .slot {
                width: 100%;
                height: 10px;
                background: #000;
                border-radius: 4px;
                position: relative;
            }
            .slot::after {
                content: attr(data-label);
                position: absolute;
                top: -18px;
                left: 0;
                font-size: 10px;
                color: #95a5a6;
            }

            @keyframes shake {
                0%, 100% {
                    transform: translateX(0);
                }
                20%, 60% {
                    transform: translateX(-8px);
                }
                40%, 80% {
                    transform: translateX(8px);
                }
            }
            @keyframes success-glow {
                50% {
                    border-color: #2ecc71;
                    box-shadow: 0 0 30px rgba(46, 204, 113, 0.5);
                }
            }
            .error-anim {
                animation: shake 0.4s ease-in-out;
                border-color: #e74c3c !important;
            }
            .success-anim {
                animation: success-glow 0.8s ease-in-out;
            }

            .baucher-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .baucher-paper {
                background: #fff;
                color: #333;
                padding: 20px;
                width: 300px;
                font-family: 'Courier New', Courier, monospace;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                border-radius: 2px;
                position: relative;
                /* Animaci√≥n de salida */
                animation: slideDown 0.8s ease-out;
            }

            .baucher-content {
                white-space: pre-wrap; /* Mantiene los saltos de l√≠nea del SP */
                font-size: 14px;
                line-height: 1.2;
                border-bottom: 1px dashed #ccc;
                margin-bottom: 15px;
            }

            .btn-baucher-close {
                width: 100%;
                background: #28a745;
                color: white;
                border: none;
                padding: 10px;
                cursor: pointer;
                font-weight: bold;
            }

            @keyframes slideDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

        </style> 
    </head> 

    <body layout:fragment="body"> 
        <div class="main-content">
            <div class="atm-container" id="atmContainer"> 

                <div class="atm-screen"> 
                    <div id="atmMessage">‚úî Bienvenido</div> 

                    <form id="loginCajero"> 
                        <h4 style="text-align:center; color:#2c3e50; margin-top:0;">BIENVENIDO</h4>
                        <label>No. Tarjeta</label> 
                        <input type="text" id="noTarjeta" class="atm-input" placeholder="0000 0000 0000 0000"> 
                        <label>PIN</label> 
                        <input type="password" id="pin" class="atm-input" placeholder="****"> 
                        <button class="btn-enter">Ingresar</button> 
                    </form> 

                    <div class="atm-buttons" style="display:none;"> 
                        <button class="btn-action" id="botonRetirar">Realizar Retiro</button> 
                        <button class="btn-action">Consultar Saldo</button> 
                        <button class="btn-action" th:if="${session.rol == 'ADMIN'}" id="botonRellenar"> 
                            Rellenar Cajero
                        </button> 
                    </div> 

                    <form id="formRetirar" style="display: none;"> 
                        <h4 style="text-align:center; color:#2c3e50;">MONTO A RETIRAR</h4>
                        <input type="number" step="0.01" id="monto" class="atm-input" placeholder="Ingrese monto"> 
                        <button class="btn-enter">Confirmar Retiro</button> 
                    </form> 

                    <form id="formRellenar" style="display:none;"> 
                        <h4 style="text-align:center; color:#2c3e50;">RELLENO DE CAJERO</h4>
                        <input type="number" step="1" id="montoRellenar" class="atm-input" placeholder="Cantidad"> 
                        <select id="denominacion" class="atm-input"> 
                            <option value="0">Seleccione Denominaci√≥n</option> 
                        </select> 
                        <button class="btn-enter">Confirmar Relleno</button> 
                    </form> 
                </div> 

                <div class="atm-hardware"> 
                    <div class="atm-keypad"> 
                        <button>1</button><button>2</button><button>3</button> 
                        <button>4</button><button>5</button><button>6</button> 
                        <button>7</button><button>8</button><button>9</button> 
                        <button class="clear">C</button> <button>0</button> <button class="ok">OK</button> 
                    </div> 
                    <div class="slots-container">
                        <div class="slot" data-label="Recibo"></div>
                        <div class="slot" data-label="Billetes"></div>
                    </div>
                </div> 
            </div> 

            <div id="modalBaucher" class="baucher-overlay" style="display:none;">
                <div class="baucher-paper">
                    <div class="baucher-content" id="baucherTexto">
                    </div>
                    <button onclick="cerrarBaucher()" class="btn-baucher-close">FINALIZAR</button>
                </div>
            </div>
        </div>

        <input type="hidden" id="cajeroIdHidden" th:value="${cajero.idCajero}"> 

        <script th:inline="javascript"> const TOKEN = /*[[${token}]]*/ '';</script> 
        <script>
            let noTarjetaGlobal = null;
            function mostrarMensaje(texto, tipo) {
                const estilos = {success: {bg: '#2ecc71', color: '#fff'}, error: {bg: '#e74c3c', color: '#fff'}, info: {bg: '#f1c40f', color: '#2c3e50'}};
                $('#atmMessage').css({background: estilos[tipo].bg, color: estilos[tipo].color}).text(texto).fadeIn(200);
            }
            function animarError() {
                $('#atmContainer').addClass('error-anim');
                setTimeout(() => $('#atmContainer').removeClass('error-anim'), 400);
            }
            function animarExito() {
                $('#atmContainer').addClass('success-anim');
                setTimeout(() => $('#atmContainer').removeClass('success-anim'), 600);
            }

            $(document).ready(function () {
                let inputActivo = null;

                $('input').on('focus', function () {
                    inputActivo = $(this);
                });

                $('.atm-keypad button').on('click', function () {
                    const valor = $(this).text();

                    if (!inputActivo)
                        return;

                    if (valor === 'C') {
                        inputActivo.val('');
                    } else if (valor === 'OK') {
                        inputActivo.closest('form').submit();
                    } else if (!isNaN(valor)) {
                        inputActivo.val(inputActivo.val() + valor);
                    }
                });
            });

            $(document).ready(function () {
                $('#loginCajero').on('submit', function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:8080/api/cajero/loginCajero',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            NoTarjeta: $('#noTarjeta').val(), 
                            PIN: $('#pin').val(), 
                            IdCajero: $('#cajeroIdHidden').val()}),
                        success: function (response) {
                            if (response.correct) {
                                noTarjetaGlobal = $('#noTarjeta').val();
                                mostrarMensaje('‚úÖ Bienvenido', 'success');
                                animarExito();
                                $('#loginCajero').fadeOut(300, () => $('.atm-buttons').fadeIn(300));
                            } else {
                                mostrarMensaje(response.errorMessage, 'error');
                                animarError();
                            }
                        },
                        error: animarError
                    });
                });

                $('#botonRetirar').on('click', function () {
                    $('.atm-buttons').fadeOut(300, () => $('#formRetirar').fadeIn(300));
                });
                $('#botonRellenar').on('click', function () {
                    $('.atm-buttons').fadeOut(300, () => $('#formRellenar').fadeIn(300));
                });

                $('#formRetirar').on('submit', function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:8080/api/retirar',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            NoTarjeta: noTarjetaGlobal, 
                            Monto: $('#monto').val(), 
                            IdCajero: $('#cajeroIdHidden').val()}),
                        beforeSend: () => mostrarMensaje('‚è≥ Procesando...', 'info'),
                        success: function (response) {
                            if (response.correct) {
                                mostrarMensaje('üí∏ ' + response.object, 'success');
                                llamarImpresion($('#cajeroIdHidden').val());
                                
                                setTimeout(() => {
                                    $('#formRetirar').fadeOut(300, () => $('.atm-buttons').fadeIn(300));
                                }, 1500);
                            } else {
                                mostrarMensaje(response.errorMessage, 'error');
                            }
                        }
                    });
                });

                // L√≥gica de relleno y carga de denominaciones original...
                const $select = $('#denominacion');
                const denominacionesManuales = [
                    {id: 1, nombre: "1000"},
                    {id: 2, nombre: "500"},
                    {id: 3, nombre: "200"},
                    {id: 4, nombre: "100"},
                    {id: 5, nombre: "50"},
                    {id: 6, nombre: "20"},
                    {id: 7, nombre: "10"},
                    {id: 8, nombre: "5"},
                    {id: 9, nombre: "2"},
                    {id: 10, nombre: "1"},
                    {id: 11, nombre: "0.5"}];
                $.each(denominacionesManuales, (i, item) => {
                    $select.append(`<option value="${item.id}">${item.nombre}</option>`);
                });
            });


            function llamarImpresion(idCajero) {
                $.ajax({
                    url: 'http://localhost:8080/api/imprimir',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({idCajero: idCajero}),
                    success: function (res) {
                        if (res.correct) {
                            const texto = Array.isArray(res.object) ? res.object.join('\n') : res.object;

                            $("#baucherTexto").text(texto);
                            $("#modalBaucher").fadeIn(500);
                        }
                    }
                });
            }

            function cerrarBaucher() {
                $("#modalBaucher").fadeOut(300, function () {
                    location.reload();
                });
            }
            
        </script> 
    </body> 
</html>